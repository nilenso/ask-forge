# Sandbox worker container.
# See isolation/ for security primitives (bwrap, seccomp).

FROM oven/bun:1-alpine AS builder

# Install build dependencies
RUN apk add --no-cache gcc musl-dev libseccomp-dev libseccomp-static linux-headers

# Copy and build seccomp tools
COPY isolation/seccomp/ /build/
WORKDIR /build

# Build the BPF filter generator and generate the filter
RUN gcc -o seccomp-net-block seccomp-net-block.c -lseccomp \
    && ./seccomp-net-block /build/net-block.bpf

# Build apply-seccomp (static binary for portability)
RUN gcc -static -O2 -o apply-seccomp apply-seccomp.c

# --- Runtime stage ---
FROM oven/bun:1-alpine

RUN apk add --no-cache \
    git \
    ripgrep \
    findutils \
    coreutils \
    bubblewrap \
    bash \
    libseccomp \
    && adduser -D -h /home/forge forge \
    && mkdir -p /home/forge/repos \
    && chown -R forge:forge /home/forge

# Copy seccomp binaries and filter from builder
COPY --from=builder /build/apply-seccomp /usr/local/bin/apply-seccomp
COPY --from=builder /build/net-block.bpf /etc/seccomp/net-block.bpf
RUN chmod +x /usr/local/bin/apply-seccomp

COPY worker.ts /app/worker.ts
COPY isolation/index.ts /app/isolation/index.ts

USER forge
WORKDIR /home/forge

EXPOSE 8080

CMD ["bun", "run", "/app/worker.ts"]
