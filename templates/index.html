{% extends "base.html" %}

{% block title %}Review System{% endblock %}

{% block extra_styles %}
.clickable-table tbody tr:hover {
    background: #e8f4fc;
}
{% endblock %}

{% block content %}
<h1>Review System</h1>

<!-- Review Progress Section -->
<div class="card">
    <h2>Review Progress</h2>
    <p class="text-muted" style="margin-bottom: 15px;">Click a row to review that run</p>
    {% if runs %}
    <table class="clickable-table">
        <thead>
            <tr>
                <th>Run ID</th>
                <th>Agent</th>
                <th>Date</th>
                <th>Examples</th>
                <th>Facts</th>
                <th>Review Status</th>
            </tr>
        </thead>
        <tbody>
            {% for run in runs %}
            <tr onclick="window.location='/review/{{ run.id }}'" style="cursor: pointer;">
                <td><code>{{ run.id[:15] }}...</code></td>
                <td>{{ run.agent_name }}</td>
                <td>{{ run.timestamp[:16] if run.timestamp else 'N/A' }}</td>
                <td>
                    {% if run.status == 'in_progress' %}
                        <span class="text-muted">{{ run.progress_completed }}/{{ run.progress_total }}</span>
                    {% else %}
                        {{ run.total_examples }}
                    {% endif %}
                </td>
                <td>{{ run.total_facts }}</td>
                <td>
                    {% if run.status == 'in_progress' %}
                        <span class="badge badge-warning">Test Running</span>
                    {% elif run.review_status.complete %}
                        <span class="badge badge-success">Complete</span>
                    {% elif run.review_status.reviewed > 0 %}
                        <span class="badge badge-warning">{{ run.review_status.reviewed }}/{{ run.review_status.total }}</span>
                    {% else %}
                        <span class="badge badge-info">Pending</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No test runs found.</p>
    <p class="text-muted">Run a test below or use <code>python test-dataset.py [num_examples] [agent]</code></p>
    {% endif %}
</div>

<div class="card">
    <h2>Run New Test</h2>
    <form id="run-test-form" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
        <div>
            <label for="agent" style="display: block; margin-bottom: 5px; font-weight: 500;">Agent</label>
            <select id="agent" name="agent" class="form-select" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px;">
                {% for agent in agents %}
                <option value="{{ agent }}">{{ agent }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="num_examples" style="display: block; margin-bottom: 5px; font-weight: 500;">Sample Count</label>
            <input type="number" id="num_examples" name="num_examples" value="5" min="1" max="100" 
                   style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 100px;">
        </div>
        <div>
            <button type="submit" class="btn btn-success" id="run-test-btn">Run Test</button>
        </div>
        <div id="test-status" style="display: none;">
            <span class="badge badge-warning">Test running...</span>
        </div>
    </form>
</div>

<div class="card">
    <h2>Quick Start</h2>
    <ol style="margin-left: 20px; margin-top: 10px;">
        <li>Select an agent and sample count above, then click "Run Test"</li>
        <li>Click "Review" on a run to review responses</li>
        <li>Mark responses as correct/incorrect and review fact verdicts</li>
        <li>View <a href="/metrics">Metrics</a> to compare LLM vs Human accuracy</li>
    </ol>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('run-test-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const agent = document.getElementById('agent').value;
    const numExamples = document.getElementById('num_examples').value;
    const btn = document.getElementById('run-test-btn');
    const status = document.getElementById('test-status');
    
    btn.disabled = true;
    btn.textContent = 'Starting...';
    status.style.display = 'inline-block';
    
    try {
        const response = await fetch('/api/run-test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ agent, num_examples: parseInt(numExamples) })
        });
        
        const data = await response.json();
        
        if (data.success) {
            btn.textContent = 'Test Started!';
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert('Error: ' + data.error);
            btn.disabled = false;
            btn.textContent = 'Run Test';
            status.style.display = 'none';
        }
    } catch (err) {
        alert('Error starting test: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Run Test';
        status.style.display = 'none';
    }
});
</script>
{% endblock %}
