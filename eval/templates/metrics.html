{% extends "base.html" %}

{% block title %}Metrics - Review System{% endblock %}

{% block extra_styles %}
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.metric-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.metric-value {
    font-size: 2em;
    font-weight: bold;
    color: #2c3e50;
}
.metric-value.good { color: #27ae60; }
.metric-value.medium { color: #f39c12; }
.metric-value.poor { color: #e74c3c; }
.metric-label {
    color: #666;
    font-size: 13px;
    margin-top: 5px;
}
.section-header {
    background: #f8f9fa;
    padding: 15px 20px;
    margin: 30px -20px 20px -20px;
    border-top: 3px solid #3498db;
}
.section-header.agent {
    border-top-color: #27ae60;
}
.section-header h2 {
    margin: 0;
    color: #2c3e50;
}
.section-header p {
    margin: 5px 0 0 0;
    color: #666;
    font-size: 14px;
}
.confusion-matrix {
    display: grid;
    grid-template-columns: auto repeat(2, 1fr);
    gap: 2px;
    max-width: 350px;
    margin: 15px auto;
}
.cm-cell {
    padding: 12px;
    text-align: center;
    background: #f8f9fa;
    font-size: 14px;
}
.cm-header {
    font-weight: bold;
    background: #e9ecef;
    font-size: 12px;
}
.cm-corner {
    background: transparent;
}
.cm-tp { background: #d4edda; color: #155724; }
.cm-fp { background: #f8d7da; color: #721c24; }
.cm-fn { background: #fff3cd; color: #856404; }
.cm-tn { background: #d1ecf1; color: #0c5460; }
.breakdown-table {
    width: 100%;
    margin-top: 15px;
}
.breakdown-table th {
    background: #f8f9fa;
    padding: 10px;
    font-size: 13px;
}
.breakdown-table td {
    padding: 10px;
    font-size: 13px;
}
.two-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
@media (max-width: 900px) {
    .two-column {
        grid-template-columns: 1fr;
    }
}
.card-inner {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.card-inner h3 {
    margin-top: 0;
    font-size: 16px;
    color: #2c3e50;
}
{% endblock %}

{% block content %}
<h1>Metrics Dashboard</h1>

{% if metrics.reviewed_facts == 0 %}
<div class="card">
    <h2>No Reviews Yet</h2>
    <p>Complete some reviews to see accuracy metrics.</p>
    <p class="text-muted">Go to <a href="/">Test Runs</a> and review some examples.</p>
</div>
{% else %}

<!-- ==================== AGENT RESPONSE SECTION ==================== -->
<div class="section-header agent">
    <h2>Agent Response Metrics</h2>
    <p>How well do agents answer questions? (Based on human review of responses and fact presence)</p>
</div>

<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-value {% if metrics.agent.response_accuracy >= 80 %}good{% elif metrics.agent.response_accuracy >= 60 %}medium{% else %}poor{% endif %}">
            {{ "%.1f"|format(metrics.agent.response_accuracy) }}%
        </div>
        <div class="metric-label">Response Accuracy</div>
    </div>
    <div class="metric-card">
        <div class="metric-value {% if metrics.agent.fact_coverage >= 80 %}good{% elif metrics.agent.fact_coverage >= 60 %}medium{% else %}poor{% endif %}">
            {{ "%.1f"|format(metrics.agent.fact_coverage) }}%
        </div>
        <div class="metric-label">Fact Coverage</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">
            {{ metrics.agent.correct_responses }}
        </div>
        <div class="metric-label">Correct Responses</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">
            {{ metrics.agent.incorrect_responses }}
        </div>
        <div class="metric-label">Incorrect Responses</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">
            {{ metrics.agent.facts_present }}
        </div>
        <div class="metric-label">Facts Present</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">
            {{ metrics.agent.facts_absent }}
        </div>
        <div class="metric-label">Facts Absent</div>
    </div>
</div>

{% if metrics.agent.by_agent %}
<div class="card">
    <h3>Performance by Agent</h3>
    <table class="breakdown-table">
        <thead>
            <tr>
                <th>Agent</th>
                <th>Responses</th>
                <th>Correct</th>
                <th>Incorrect</th>
                <th>Response Accuracy</th>
                <th>Facts Present</th>
                <th>Facts Absent</th>
                <th>Fact Coverage</th>
            </tr>
        </thead>
        <tbody>
            {% for agent, stats in metrics.agent.by_agent.items() %}
            {% set response_acc = (stats.correct_responses / stats.total_responses * 100) if stats.total_responses > 0 else 0 %}
            {% set total_facts = stats.facts_present + stats.facts_absent %}
            {% set fact_cov = (stats.facts_present / total_facts * 100) if total_facts > 0 else 0 %}
            <tr>
                <td><strong>{{ agent }}</strong></td>
                <td>{{ stats.total_responses }}</td>
                <td class="text-success">{{ stats.correct_responses }}</td>
                <td class="text-danger">{{ stats.incorrect_responses }}</td>
                <td class="{% if response_acc >= 80 %}text-success{% elif response_acc >= 60 %}text-muted{% else %}text-danger{% endif %}">
                    {{ "%.1f"|format(response_acc) }}%
                </td>
                <td>{{ stats.facts_present }}</td>
                <td>{{ stats.facts_absent }}</td>
                <td class="{% if fact_cov >= 80 %}text-success{% elif fact_cov >= 60 %}text-muted{% else %}text-danger{% endif %}">
                    {{ "%.1f"|format(fact_cov) }}%
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="two-column">
    {% if metrics.agent.by_difficulty %}
    <div class="card-inner">
        <h3>Agent Fact Coverage by Difficulty</h3>
        <table class="breakdown-table">
            <thead>
                <tr>
                    <th>Difficulty</th>
                    <th>Present</th>
                    <th>Absent</th>
                    <th>Coverage</th>
                </tr>
            </thead>
            <tbody>
                {% for difficulty, stats in metrics.agent.by_difficulty.items() %}
                {% set total = stats.facts_present + stats.facts_absent %}
                {% set coverage = (stats.facts_present / total * 100) if total > 0 else 0 %}
                <tr>
                    <td>{{ difficulty }}</td>
                    <td>{{ stats.facts_present }}</td>
                    <td>{{ stats.facts_absent }}</td>
                    <td class="{% if coverage >= 80 %}text-success{% elif coverage >= 60 %}text-muted{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(coverage) }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    {% if metrics.agent.by_type %}
    <div class="card-inner">
        <h3>Agent Fact Coverage by Type</h3>
        <table class="breakdown-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Present</th>
                    <th>Absent</th>
                    <th>Coverage</th>
                </tr>
            </thead>
            <tbody>
                {% for type, stats in metrics.agent.by_type.items() %}
                {% set total = stats.facts_present + stats.facts_absent %}
                {% set coverage = (stats.facts_present / total * 100) if total > 0 else 0 %}
                <tr>
                    <td>{{ type }}</td>
                    <td>{{ stats.facts_present }}</td>
                    <td>{{ stats.facts_absent }}</td>
                    <td class="{% if coverage >= 80 %}text-success{% elif coverage >= 60 %}text-muted{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(coverage) }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- ==================== LLM-AS-A-JUDGE SECTION ==================== -->
<div class="section-header">
    <h2>LLM-as-a-Judge Metrics</h2>
    <p>How well does the LLM judge identify whether facts are present in agent responses? (Compared to human ground truth)</p>
</div>

<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-value {% if metrics.llm_judge.accuracy >= 80 %}good{% elif metrics.llm_judge.accuracy >= 60 %}medium{% else %}poor{% endif %}">
            {{ "%.1f"|format(metrics.llm_judge.accuracy) }}%
        </div>
        <div class="metric-label">Accuracy</div>
    </div>
    <div class="metric-card">
        <div class="metric-value {% if metrics.llm_judge.precision >= 80 %}good{% elif metrics.llm_judge.precision >= 60 %}medium{% else %}poor{% endif %}">
            {{ "%.1f"|format(metrics.llm_judge.precision) }}%
        </div>
        <div class="metric-label">Precision</div>
    </div>
    <div class="metric-card">
        <div class="metric-value {% if metrics.llm_judge.recall >= 80 %}good{% elif metrics.llm_judge.recall >= 60 %}medium{% else %}poor{% endif %}">
            {{ "%.1f"|format(metrics.llm_judge.recall) }}%
        </div>
        <div class="metric-label">Recall</div>
    </div>
</div>

<div class="two-column">
    <div class="card-inner">
        <h3>Confusion Matrix</h3>
        <div class="confusion-matrix">
            <div class="cm-cell cm-corner"></div>
            <div class="cm-cell cm-header">Human: Present</div>
            <div class="cm-cell cm-header">Human: Absent</div>
            
            <div class="cm-cell cm-header">LLM: Present</div>
            <div class="cm-cell cm-tp">
                <strong>{{ metrics.llm_judge.tp }}</strong><br>
                <small>TP</small>
            </div>
            <div class="cm-cell cm-fp">
                <strong>{{ metrics.llm_judge.fp }}</strong><br>
                <small>FP</small>
            </div>
            
            <div class="cm-cell cm-header">LLM: Absent</div>
            <div class="cm-cell cm-fn">
                <strong>{{ metrics.llm_judge.fn }}</strong><br>
                <small>FN</small>
            </div>
            <div class="cm-cell cm-tn">
                <strong>{{ metrics.llm_judge.tn }}</strong><br>
                <small>TN</small>
            </div>
        </div>
        <p style="font-size: 12px; color: #666; margin: 10px 0 0 0;">
            <strong>TP:</strong> LLM correct (fact present) |
            <strong>FP:</strong> LLM wrong (said present) |
            <strong>FN:</strong> LLM missed (fact was present) |
            <strong>TN:</strong> LLM correct (fact absent)
        </p>
    </div>
    
    <div class="card-inner">
        <h3>By Difficulty</h3>
        {% if metrics.llm_judge.by_difficulty %}
        <table class="breakdown-table">
            <thead>
                <tr>
                    <th>Difficulty</th>
                    <th>TP</th>
                    <th>FP</th>
                    <th>FN</th>
                    <th>TN</th>
                    <th>Acc</th>
                </tr>
            </thead>
            <tbody>
                {% for difficulty, stats in metrics.llm_judge.by_difficulty.items() %}
                {% set total = stats.tp + stats.fp + stats.fn + stats.tn %}
                {% set accuracy = ((stats.tp + stats.tn) / total * 100) if total > 0 else 0 %}
                <tr>
                    <td>{{ difficulty }}</td>
                    <td>{{ stats.tp }}</td>
                    <td>{{ stats.fp }}</td>
                    <td>{{ stats.fn }}</td>
                    <td>{{ stats.tn }}</td>
                    <td class="{% if accuracy >= 80 %}text-success{% elif accuracy >= 60 %}text-muted{% else %}text-danger{% endif %}">
                        {{ "%.0f"|format(accuracy) }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">No data yet</p>
        {% endif %}
    </div>
</div>

{% if metrics.llm_judge.by_type %}
<div class="card" style="margin-top: 20px;">
    <h3>LLM Judge Accuracy by Question Type</h3>
    <table class="breakdown-table">
        <thead>
            <tr>
                <th>Type</th>
                <th>TP</th>
                <th>FP</th>
                <th>FN</th>
                <th>TN</th>
                <th>Accuracy</th>
                <th>Precision</th>
                <th>Recall</th>
            </tr>
        </thead>
        <tbody>
            {% for type, stats in metrics.llm_judge.by_type.items() %}
            {% set total = stats.tp + stats.fp + stats.fn + stats.tn %}
            {% set accuracy = ((stats.tp + stats.tn) / total * 100) if total > 0 else 0 %}
            {% set precision = (stats.tp / (stats.tp + stats.fp) * 100) if (stats.tp + stats.fp) > 0 else 0 %}
            {% set recall = (stats.tp / (stats.tp + stats.fn) * 100) if (stats.tp + stats.fn) > 0 else 0 %}
            <tr>
                <td>{{ type }}</td>
                <td>{{ stats.tp }}</td>
                <td>{{ stats.fp }}</td>
                <td>{{ stats.fn }}</td>
                <td>{{ stats.tn }}</td>
                <td class="{% if accuracy >= 80 %}text-success{% elif accuracy >= 60 %}text-muted{% else %}text-danger{% endif %}">
                    {{ "%.1f"|format(accuracy) }}%
                </td>
                <td>{{ "%.1f"|format(precision) }}%</td>
                <td>{{ "%.1f"|format(recall) }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endif %}
{% endblock %}
